<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>JWT Auth & File Upload</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }
        .container {
            max-width: 500px;
            margin: auto;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        h1 {
            text-align: center;
        }
        .form-group {
            margin-bottom: 10px;
        }
        label {
            display: block;
            margin-bottom: 4px;
        }
        input[type="text"],
        input[type="password"],
        input[type="file"] {
            width: 100%;
            padding: 6px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
        }
        .link-btn {
            color: #007bff;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            margin-top: 10px;
            text-align: left;
            display: block;
        }
        .message {
            margin: 10px 0;
        }
        .hidden {
            display: none;
        }
        #fileInfo,
        #uploadResult,
        .user-info {
            margin: 10px 0;
        }
        #uploadResult pre {
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
</head>
<body>
<!-- Login Screen -->
<div id="loginScreen" class="screen active">
    <div class="container">
        <h1>Login</h1>
        <div id="loginMessage" class="message"></div>
        <form id="loginForm">
            <div class="form-group">
                <label for="loginUsername">Username:</label>
                <input type="text" id="loginUsername" required />
            </div>
            <div class="form-group">
                <label for="loginPassword">Password:</label>
                <input type="password" id="loginPassword" required />
            </div>
            <button type="submit">Login</button>
        </form>
        <button class="link-btn" onclick="showRegisterScreen()">
            Don't have an account? Register here
        </button>
    </div>
</div>

<!-- Register Screen -->
<div id="registerScreen" class="screen">
    <div class="container">
        <h1>Register</h1>
        <div id="registerMessage" class="message"></div>
        <form id="registerForm">
            <div class="form-group">
                <label for="regUsername">Username:</label>
                <input type="text" id="regUsername" required />
            </div>
            <div class="form-group">
                <label for="regPassword">Password:</label>
                <input type="password" id="regPassword" required />
            </div>
            <div class="form-group">
                <label for="regPasswordConfirm">Confirm Password:</label>
                <input type="password" id="regPasswordConfirm" required />
            </div>
            <button type="submit">Register</button>
        </form>
        <button class="link-btn" onclick="showLoginScreen()">
            Already have an account? Login here
        </button>
    </div>
</div>

<!-- Upload Screen -->
<div id="uploadScreen" class="screen">
    <div class="container">
        <h1>File Upload</h1>
        <div class="user-info">
            Welcome, <span id="welcomeUser"></span>
        </div>
        <div id="uploadMessage" class="message"></div>
        <form id="uploadForm">
            <div class="form-group">
                <label for="fileInput">Select Image File:</label>
                <input type="file" id="fileInput" accept="image/*" required />
            </div>
            <div id="fileInfo" class="hidden">
                <p><strong>Name:</strong> <span id="fileName"></span></p>
                <p><strong>Size:</strong> <span id="fileSize"></span></p>
                <p><strong>Type:</strong> <span id="fileType"></span></p>
            </div>
            <button type="submit" id="uploadBtn" disabled>Upload File</button>
        </form>
        <div id="uploadResult" class="hidden">
            <pre id="uploadData"></pre>
        </div>
        <button onclick="revokeToken()">Revoke Token</button>
        <button onclick="logout()">Logout</button>
    </div>
</div>

<script>
    // API Base URL
    const API_BASE = 'http://localhost:8080';

    // Global variables
    let currentToken = localStorage.getItem('jwt_token');
    let currentUser = localStorage.getItem('username');

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        if (currentToken && currentUser) {
            showUploadScreen();
        } else {
            showLoginScreen();
        }

        // Add form event listeners
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        document.getElementById('registerForm').addEventListener('submit', handleRegister);
        document.getElementById('uploadForm').addEventListener('submit', handleUpload);
        document.getElementById('fileInput').addEventListener('change', showFileInfo);

        // Test server connection
        testConnection();
    });

    // Screen Navigation
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(screenId).classList.add('active');
    }

    function showLoginScreen() {
        showScreen('loginScreen');
        clearForm('loginForm');
        clearMessage('loginMessage');
    }

    function showRegisterScreen() {
        showScreen('registerScreen');
        clearForm('registerForm');
        clearMessage('registerMessage');
    }

    function showUploadScreen() {
        showScreen('uploadScreen');
        document.getElementById('welcomeUser').textContent = currentUser || 'User';
        clearForm('uploadForm');
        clearMessage('uploadMessage');
        document.getElementById('uploadResult').classList.add('hidden');
        document.getElementById('fileInfo').classList.add('hidden');
    }

    // Utility Functions
    function showMessage(containerId, message, type = 'info') {
        const container = document.getElementById(containerId);
        container.innerHTML = `<div class="message ${type}">${message}</div>`;
    }

    function clearMessage(containerId) {
        document.getElementById(containerId).innerHTML = '';
    }

    function clearForm(formId) {
        document.getElementById(formId).reset();
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Auth Functions
    async function handleLogin(e) {
        e.preventDefault();

        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        if (!username || !password) {
            showMessage('loginMessage', 'Please fill in all fields', 'error');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();

            if (response.ok) {
                currentToken = data.token;
                currentUser = username;
                localStorage.setItem('jwt_token', currentToken);
                localStorage.setItem('username', currentUser);

                showMessage('loginMessage', 'Login successful! Redirecting...', 'success');
                setTimeout(() => showUploadScreen(), 1000);
            } else {
                showMessage('loginMessage', data.error || 'Login failed', 'error');
            }
        } catch (error) {
            showMessage('loginMessage', `Network error: ${error.message}`, 'error');
        }
    }

    async function handleRegister(e) {
        e.preventDefault();

        const username = document.getElementById('regUsername').value;
        const password = document.getElementById('regPassword').value;
        const confirmPassword = document.getElementById('regPasswordConfirm').value;

        if (!username || !password || !confirmPassword) {
            showMessage('registerMessage', 'Please fill in all fields', 'error');
            return;
        }

        if (password !== confirmPassword) {
            showMessage('registerMessage', 'Passwords do not match', 'error');
            return;
        }

        if (password.length < 6) {
            showMessage('registerMessage', 'Password must be at least 6 characters', 'error');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();

            if (response.ok) {
                currentToken = data.token;
                currentUser = username;
                localStorage.setItem('jwt_token', currentToken);
                localStorage.setItem('username', currentUser);

                showMessage('registerMessage', 'Registration successful! Redirecting...', 'success');
                setTimeout(() => showUploadScreen(), 1000);
            } else {
                showMessage('registerMessage', data.error || 'Registration failed', 'error');
            }
        } catch (error) {
            showMessage('registerMessage', `Network error: ${error.message}`, 'error');
        }
    }

    function logout() {
        currentToken = null;
        currentUser = null;
        localStorage.removeItem('jwt_token');
        localStorage.removeItem('username');
        showLoginScreen();
    }

    async function revokeToken() {
        if (!currentToken) {
            showMessage('uploadMessage', 'No token to revoke', 'error');
            return;
        }

        if (!confirm('Are you sure you want to revoke your token? You will be logged out.')) {
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/revoke`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${currentToken}`,
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (response.ok) {
                showMessage('uploadMessage', 'Token revoked successfully. Logging out...', 'success');
                setTimeout(() => logout(), 1500);
            } else {
                showMessage('uploadMessage', data.error || 'Token revocation failed', 'error');
            }
        } catch (error) {
            showMessage('uploadMessage', `Network error: ${error.message}`, 'error');
        }
    }

    // File Upload Functions
    function showFileInfo() {
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const uploadBtn = document.getElementById('uploadBtn');

        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];

            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileType').textContent = file.type;

            fileInfo.classList.remove('hidden');

            // Validate file
            if (!file.type.startsWith('image/')) {
                showMessage('uploadMessage', 'Please select an image file', 'error');
                uploadBtn.disabled = true;
            } else if (file.size > 8 * 1024 * 1024) {
                showMessage('uploadMessage', 'File size must be less than 8MB', 'error');
                uploadBtn.disabled = true;
            } else {
                clearMessage('uploadMessage');
                uploadBtn.disabled = false;
            }
        } else {
            fileInfo.classList.add('hidden');
            uploadBtn.disabled = true;
        }
    }

    async function handleUpload(e) {
        e.preventDefault();

        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');

        if (!currentToken) {
            showMessage('uploadMessage', 'Please login first', 'error');
            return;
        }

        if (!fileInput.files.length) {
            showMessage('uploadMessage', 'Please select a file', 'error');
            return;
        }

        const file = fileInput.files[0];

        // Validate file again
        if (!file.type.startsWith('image/')) {
            showMessage('uploadMessage', 'File must be an image', 'error');
            return;
        }

        if (file.size > 8 * 1024 * 1024) {
            showMessage('uploadMessage', 'File size exceeds 8MB limit', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('data', file);

        try {
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            showMessage('uploadMessage', 'Uploading file...', 'info');

            const response = await fetch(`${API_BASE}/upload`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${currentToken}`
                },
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                showMessage('uploadMessage', 'File uploaded successfully!', 'success');

                // Show upload result
                document.getElementById('uploadData').textContent = JSON.stringify(data, null, 2);
                document.getElementById('uploadResult').classList.remove('hidden');

                // Clear form
                clearForm('uploadForm');
                document.getElementById('fileInfo').classList.add('hidden');
            } else {
                showMessage('uploadMessage', data.error || 'Upload failed', 'error');

                // Handle token expiration
                if (response.status === 401) {
                    showMessage('uploadMessage', 'Token expired or invalid. Please login again.', 'error');
                    setTimeout(() => logout(), 2000);
                }
            }
        } catch (error) {
            showMessage('uploadMessage', `Network error: ${error.message}`, 'error');
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload File';
        }
    }

    // Test connection
    async function testConnection() {
        try {
            const response = await fetch(`${API_BASE}/health`);
            if (!response.ok) {
                console.warn('Server health check failed');
            }
        } catch (error) {
            console.warn('Cannot connect to server:', error.message);
        }
    }
</script>
</body>
</html>
